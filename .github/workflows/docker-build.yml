name: Build Docker Images

on:
  workflow_run:
    workflows: ["Publish to PyPI"]
    types:
      - completed
  # Also allow manual trigger for rebuilds
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag (e.g., v1.0.0 or v1.0.0rc1)'
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    # Only run if PyPI publish succeeded (or manual trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: Check out code
      uses: actions/checkout@v5
      with:
        # For workflow_run, checkout the tag that triggered it
        ref: ${{ github.event.workflow_run.head_branch || github.event.inputs.tag }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract version from tag/ref
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          REF="${{ github.event.inputs.tag }}"
        else
          REF="${{ github.event.workflow_run.head_branch }}"
        fi
        
        # Extract version (strip 'v' prefix and 'refs/tags/' if present)
        VERSION="${REF#refs/tags/}"
        VERSION="${VERSION#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ref=$REF" >> $GITHUB_OUTPUT
        
        # Determine if this is a pre-release
        if [[ $VERSION =~ (rc|a|b) ]]; then
          echo "prerelease=true" >> $GITHUB_OUTPUT
          echo "is_latest=false" >> $GITHUB_OUTPUT
        else
          echo "prerelease=false" >> $GITHUB_OUTPUT
          echo "is_latest=true" >> $GITHUB_OUTPUT
        fi
        
        echo "Building Docker image for MXCP version: $VERSION"
        echo "Pre-release: $([ ${{ steps.version.outputs.prerelease }} = 'true' ] && echo 'YES' || echo 'NO')"
    
    - name: Wait for PyPI availability
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PRERELEASE="${{ steps.version.outputs.prerelease }}"
        
        echo "Waiting for mxcp==$VERSION to be available on PyPI..."
        
        # Try for up to 5 minutes
        for i in {1..30}; do
          if [ "$PRERELEASE" = "true" ]; then
            if pip index versions mxcp --pre 2>/dev/null | grep -q "$VERSION"; then
              echo "✓ Version $VERSION found on PyPI"
              exit 0
            fi
          else
            if pip index versions mxcp 2>/dev/null | grep -q "$VERSION"; then
              echo "✓ Version $VERSION found on PyPI"
              exit 0
            fi
          fi
          
          echo "Attempt $i/30: Version not yet available, waiting 10s..."
          sleep 10
        done
        
        echo "ERROR: Version $VERSION not found on PyPI after 5 minutes"
        exit 1
    
    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/raw-labs/mxcp
        tags: |
          type=semver,pattern={{version}},value=${{ steps.version.outputs.version }}
          type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.version }}
          type=semver,pattern={{major}},value=${{ steps.version.outputs.version }},enable=${{ steps.version.outputs.is_latest }}
          type=raw,value=latest,enable=${{ steps.version.outputs.is_latest }}
    
    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        context: .
        file: docker/Dockerfile
        build-args: |
          MXCP_VERSION=${{ steps.version.outputs.version }}
          MXCP_PRERELEASE=${{ steps.version.outputs.prerelease }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Create release summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << EOF
        ## Docker Image Published
        
        **Version**: ${{ steps.version.outputs.version }}
        **Pre-release**: ${{ steps.version.outputs.prerelease }}
        
        ### Pull Image
        \`\`\`bash
        docker pull ghcr.io/raw-labs/mxcp:${{ steps.version.outputs.version }}
        \`\`\`
        
        ### Tags Created
        \`\`\`
        ${{ steps.meta.outputs.tags }}
        \`\`\`
        EOF


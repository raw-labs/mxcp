name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'        # Stable releases (e.g., v0.9.0, v1.0.0)
      - 'v*.*.*rc*'     # Release candidates (e.g., v1.0.0rc1)
      - 'v*.*.*a*'      # Alpha releases (e.g., v1.0.0a1)
      - 'v*.*.*b*'      # Beta releases (e.g., v1.0.0b1)

permissions:
  contents: read
  id-token: write  # Required for PyPI trusted publishing

jobs:
  publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v5
    
    - name: Install uv
      uses: astral-sh/setup-uv@v7
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Install build dependencies
      run: |
        uv sync --all-extras --dev
    
    - name: Verify version matches tag
      run: |
        TAG_VERSION="${GITHUB_REF#refs/tags/v}"
        PACKAGE_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        
        echo "Tag version: $TAG_VERSION"
        echo "Package version: $PACKAGE_VERSION"
        
        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "ERROR: Tag version ($TAG_VERSION) doesn't match package version ($PACKAGE_VERSION)"
          exit 1
        fi
    
    - name: Build package
      run: |
        uv run --module build
    
    - name: Check package metadata
      run: |
        uv run twine check dist/*
    
    - name: List built artifacts
      run: |
        ls -lh dist/
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
        verbose: true




name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'        # Stable releases (e.g., v0.9.0, v1.0.0)
      - 'v*.*.*rc*'     # Release candidates (e.g., v1.0.0rc1)
      - 'v*.*.*a*'      # Alpha releases (e.g., v1.0.0a1)
      - 'v*.*.*b*'      # Beta releases (e.g., v1.0.0b1)

permissions:
  contents: read
  id-token: write  # Required for PyPI trusted publishing

jobs:
  publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v5
    
    - name: Install uv
      uses: astral-sh/setup-uv@v7
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Install build dependencies
      run: |
        uv sync --all-extras --dev
    
    - name: Verify version matches tag
      run: |
        TAG_VERSION="${GITHUB_REF#refs/tags/v}"
        PACKAGE_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        
        echo "Tag version: $TAG_VERSION"
        echo "Package version: $PACKAGE_VERSION"
        
        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "ERROR: Tag version ($TAG_VERSION) doesn't match package version ($PACKAGE_VERSION)"
          exit 1
        fi
    
    - name: Build package
      run: |
        uv run --module build
    
    - name: Check package metadata
      run: |
        uv run twine check dist/*
    
    - name: List built artifacts
      run: |
        ls -lh dist/
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
        verbose: true
  
  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Check out code
      uses: actions/checkout@v5
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract version from tag
      id: version
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Determine if this is a pre-release (for tagging)
        if [[ $VERSION =~ (rc|a|b) ]]; then
          echo "is_latest=false" >> $GITHUB_OUTPUT
        else
          echo "is_latest=true" >> $GITHUB_OUTPUT
        fi
        
        echo "Building Docker image for MXCP version: $VERSION"
    
    - name: Wait for PyPI CDN propagation
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        MAX_WAIT=600  # 10 minutes
        ELAPSED=0
        SLEEP=10
        
        echo "Waiting for mxcp==$VERSION to be available on PyPI..."
        
        while [ $ELAPSED -lt $MAX_WAIT ]; do
          # Check PyPI JSON API for version-specific endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/mxcp/$VERSION/json")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ“ Package mxcp==$VERSION is available on PyPI"
            exit 0
          fi
          
          echo "Package not yet available (HTTP $HTTP_CODE), waiting ${SLEEP}s... (${ELAPSED}s elapsed)"
          sleep $SLEEP
          ELAPSED=$((ELAPSED + SLEEP))
          
          # Exponential backoff up to 30s
          if [ $SLEEP -lt 30 ]; then
            SLEEP=$((SLEEP + 5))
          fi
        done
        
        echo "ERROR: Package did not become available within ${MAX_WAIT}s"
        exit 1
    
    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/raw-labs/mxcp
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}
          type=raw,value=latest,enable=${{ steps.version.outputs.is_latest }}
    
    - name: Build and push
      uses: docker/build-push-action@v6
      with:
        context: .
        file: docker/Dockerfile
        build-args: |
          MXCP_VERSION=${{ steps.version.outputs.version }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max




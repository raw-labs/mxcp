name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'        # Stable releases (e.g., v0.9.0, v1.0.0)
      - 'v*.*.*rc*'     # Release candidates (e.g., v1.0.0rc1)
      - 'v*.*.*a*'      # Alpha releases (e.g., v1.0.0a1)
      - 'v*.*.*b*'      # Beta releases (e.g., v1.0.0b1)

env:
  MXCP_DISABLE_ANALYTICS: "1"  # Disable PostHog analytics in CI

permissions:
  contents: read
  id-token: write  # Required for PyPI trusted publishing

jobs:
  publish:
    name: Build and publish to PyPI
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v6
    
    - name: Install uv
      uses: astral-sh/setup-uv@v7
    
    - name: Set up Python
      run: uv python install 3.11
    
    - name: Install build dependencies
      run: |
        uv sync --all-extras --dev
    
    - name: Verify version matches tag
      run: |
        TAG_VERSION="${GITHUB_REF#refs/tags/v}"
        PACKAGE_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        
        echo "Tag version: $TAG_VERSION"
        echo "Package version: $PACKAGE_VERSION"
        
        if [ "$TAG_VERSION" != "$PACKAGE_VERSION" ]; then
          echo "ERROR: Tag version ($TAG_VERSION) doesn't match package version ($PACKAGE_VERSION)"
          exit 1
        fi
    
    - name: Build package
      run: |
        uv run --module build
    
    - name: Check package metadata
      run: |
        uv run twine check dist/*
    
    - name: List built artifacts
      run: |
        ls -lh dist/
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        print-hash: true
        verbose: true
  
  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: read
      packages: write
      security-events: write  # Required for uploading Trivy SARIF results
    
    steps:
    - name: Check out code
      uses: actions/checkout@v6
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract version from tag
      id: version
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Convert PEP 440 format to semver for Docker
        # 0.10.0rc5 -> 0.10.0-rc5
        # 0.10.0a1 -> 0.10.0-a1
        # 0.10.0b2 -> 0.10.0-b2
        # 1.0.0 -> 1.0.0 (stable versions unchanged)
        DOCKER_VERSION=$(echo "$VERSION" | sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+)(rc|a|b)([0-9]+)$/\1-\2\3/')
        echo "docker_version=$DOCKER_VERSION" >> $GITHUB_OUTPUT
        
        # Determine if this is a pre-release (for tagging)
        if [[ $VERSION =~ (rc|a|b) ]]; then
          echo "is_latest=false" >> $GITHUB_OUTPUT
        else
          echo "is_latest=true" >> $GITHUB_OUTPUT
        fi
        
        echo "Building Docker image for MXCP version: $VERSION (Docker: $DOCKER_VERSION)"
    
    - name: Wait for PyPI CDN propagation
      run: |
        echo "Waiting 3 minutes for PyPI CDN propagation..."
        echo "Package: mxcp==${{ steps.version.outputs.version }}"
        sleep 180
        echo "âœ“ CDN propagation window complete"
    
    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/raw-labs/mxcp
        tags: |
          type=semver,pattern={{version}},value=v${{ steps.version.outputs.docker_version }}
          type=semver,pattern={{major}}.{{minor}},value=v${{ steps.version.outputs.docker_version }}
          type=semver,pattern={{major}},value=v${{ steps.version.outputs.docker_version }},enable=${{ steps.version.outputs.is_latest }}
          type=raw,value=latest,enable=${{ steps.version.outputs.is_latest }}
    
    - name: Build and push Docker image (multi-arch)
      uses: docker/build-push-action@v6
      with:
        context: .
        file: docker/Dockerfile
        build-args: |
          MXCP_VERSION=${{ steps.version.outputs.version }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    # Scan the published image (both architectures)
    - name: Scan image for vulnerabilities (amd64)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ghcr.io/raw-labs/mxcp:${{ steps.version.outputs.docker_version }}
        format: 'sarif'
        output: 'trivy-results-amd64.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Report vulnerabilities without blocking release
        scanners: 'vuln,secret'
      env:
        TRIVY_PLATFORM: linux/amd64
    
    - name: Scan image for vulnerabilities (arm64)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ghcr.io/raw-labs/mxcp:${{ steps.version.outputs.docker_version }}
        format: 'sarif'
        output: 'trivy-results-arm64.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Report vulnerabilities without blocking release
        scanners: 'vuln,secret'
      env:
        TRIVY_PLATFORM: linux/arm64
    
    - name: Generate SBOM (amd64)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ghcr.io/raw-labs/mxcp:${{ steps.version.outputs.docker_version }}
        format: 'cyclonedx'
        output: 'sbom-amd64.json'
        scanners: 'vuln'
      env:
        TRIVY_PLATFORM: linux/amd64
    
    - name: Generate SBOM (arm64)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ghcr.io/raw-labs/mxcp:${{ steps.version.outputs.docker_version }}
        format: 'cyclonedx'
        output: 'sbom-arm64.json'
        scanners: 'vuln'
      env:
        TRIVY_PLATFORM: linux/arm64
    
    - name: Upload SBOMs as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom-${{ steps.version.outputs.version }}
        path: sbom-*.json
        retention-days: 90
    
    - name: Upload Trivy results to GitHub Security (amd64)
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results-amd64.sarif'
        category: 'trivy-container-amd64'
    
    - name: Upload Trivy results to GitHub Security (arm64)
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results-arm64.sarif'
        category: 'trivy-container-arm64'



